<!DOCTYPE html>
<html lang="en">
 <head>
 <meta charset="utf-8">
 <title>MAA</title>
 <meta name="viewport" content="width=device-width,
initial-scale=1.0">
 <meta name="description" content="">
 <meta name="author" content="">
 <!-- CSS -->
 <link rel="stylesheet"
href="http://fonts.googleapis.com/css?family=Open+Sans:400italic
,400">
 <link rel="stylesheet"
href="http://fonts.googleapis.com/css?family=Droid+Sans">
 <link rel="stylesheet"
href="http://fonts.googleapis.com/css?family=Lobster">
 <link rel="stylesheet"
href="assets/bootstrap/css/bootstrap.min.css">
 <!--<link rel="stylesheet"
href="assets/prettyPhoto/css/prettyPhoto.css">-->
 <link rel="stylesheet" href="assets/css/flexslider.css">
 <link rel="stylesheet" href="assets/css/fontawesome.css">
 <link rel="stylesheet" href="assets/css/style.css">

 <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
 <!--[if lt IE 9]>
 <script
src="http://html5shim.googlecode.com/svn/trunk/html5.js"></scrip
t>
 <![endif]-->
 <!-- Favicon and touch icons -->
 <link rel="shortcut icon" href="assets/ico/favicon.ico">
 <link rel="apple-touch-icon-precomposed" sizes="144x144"
href="assets/ico/apple-touch-icon-144-precomposed.png">
 <link rel="apple-touch-icon-precomposed" sizes="114x114"
href="assets/ico/apple-touch-icon-114-precomposed.png">
 <link rel="apple-touch-icon-precomposed" sizes="72x72"
href="assets/ico/apple-touch-icon-72-precomposed.png">
 <link rel="apple-touch-icon-precomposed"
href="assets/ico/apple-touch-icon-57-precomposed.png">
 <script src="ChartNew.js"></script><!--
<script src="flot/jquery.min.js"
type="text/javascript"></script>
 <script src="flot/jquery.flot.min.js"
type="text/javascript"></script>
 <script src="flot/excanvas.min.js"
type="text/javascript"></script>
 -->


 </head>
 <body onLoad="document.getElementById('testSound').play();">

 <!-- Header -->
 <div class="container violetbg" style="position:
fixed !important; width: 320px;">
 <div class="header row" style="margin-top:
20px;">
 <div class="span12">
 <div class="navbar">
 <div class="navbar-inner"
style="background-color:#206489">
 <a class="btn btn-navbar" datatoggle="collapse" data-target=".nav-collapse">
 <span class="iconbar"></span>
<span class="iconbar"></span>
<span class="iconbar"></span>
 </a>
<div class="presentation
container" style="float:left; margin-top:-11px;">
 <h2><div
style="color:white">Mobile Audiometry App</div></h2>
 </div>
<div class="nav-collapse
collapse">
 <ul class="nav pull-right" >
 <li>
 <a href="index.html"
rel="external"><i class="icon-home"></i><br />Home</a>
 </li>
<li class="currentpage">
 <a href="takeTest.html" rel="external"><i class="iconcamera"></i><br />Take Test</a>
 </li>
<li>
 <a
href="viewHistory.html" rel="external"><i class="iconcomments"></i><br />View History</a>
 </li>
<li>
 <a href="FAQ.html"
rel="external"><i class="icon-tasks"></i><br />FAQ</a>
 </li>
 </ul>
 </div>
 </div>
 </div>
 </div>
<div id="key" class="span12" style="fontsize: 12px; color: #000000; background-color: #FFFFFF
!important; padding-bottom: 20px; display: none;"><br/>Hearing
Loss Level: <br/>
 <font style="background-color:
#A6FFBE;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&n
bsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;<font
style="background-color:
#FFFFA6;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mild&nbsp;&nbsp;&n
bsp;&nbsp;&nbsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;<font
style="background-color: #FFD5A6;">&nbsp;Moderate&nbsp;</font>
 &nbsp;&nbsp;&nbsp;<font
style="background-color:
#FFB2A6;">&nbsp;&nbsp;&nbsp;&nbsp;Severe&nbsp;&nbsp;&nbsp;&nbsp;
</font></div>
 </div>

 </div>
 <br/><br/><br/><br/>

 <div id="calibrate" style="display:inline; margin-left:
5px; margin-right: 5px;">
 <!--Accurate results require careful calibration!
Follow the steps below to calibrate your device before beginning
the test.-->
 <div class="violet" style="font-size:
17px;">Calibrate Your Device</div>
 <br/>
 1. Remove your headphones.<br/>
 <img src="headphones.png"/><br/>
 <br/>
 2. Rub your hands together in front of <br/>your nose.<br/>
 <img src="hands.png"/><br/><br/>
 3. Put your headphones on and turn your volume to
the minimum setting. <br/>
 <img src="volume.png"/><br/><br/>
 4. With headphones on, adjust your volume so the
sound you hear replicates the sound your hands just made.<br/>
 <img src="person2.png"/>

 <br/><br/>
 You are now ready to begin the audiometry exam.
Please answer all questions to the best of your ability.
 <br/><br/>
 <a href="#" onClick="newTest();" class="nextBtn"
id="calibrateBtn"> Next </a><br/><br/>
 </div>

 <div id="selectProfile" style="display:none">
 <br/>
 <br/><br/><br/>


 <div onClick="disableEnable('newUser',
'existingUser');">
 <div class="violet" style="font-size:
17px;">Select Existing Profile:</div>
 <br/>

<select id="existingUser">
 </select>


 </div>
 <div class="violet" style="font-size: 17px;"><br/>-
OR-<br/></div>
 <div onClick="disableEnable('existingUser',
'newUser');">
 <div class="violet" style="font-size:
17px;"><br/>Create a New Profile:</div>
 <br/>
 <div align="center"> <input disabled
id="newUser" type="text" size="10" style=" width:150px; textalign:center;" /> </div>
 </div>
 <br/>
 <a href="#" id="next" onClick="beginTest();"
class="nextBtn">Begin Test</a>
 <br/><br/>
 </div><div id="takeTest" style="display:none">

 <audio loop id="testSound"
src="sounds/calibrationFile.mp3" type="audio/mpeg"></audio>

 <br/><br/>

 <!--<div id="progressContainer" style="width:198px;
border-width:1px; border-style:solid; border-color:#F90; marginleft:100px;"><div id="progress" style="text-align:left;
color:#206489; background-color:#F90; width:0px;">
 &nbsp;Progress
 </div></div>-->
 <progress id="progress" max="700" value="100"
color="#FFF" backgroundColor="#F90" style="width: 225px; height:
15px; -webkit-appearance: none;">Progress</progress>

 <br/><br/><br/>

 <img src="speaker1.png" id="speaker"
class="speaker" onClick="playSound();" style="float:left;
margin-left:40px; margin-right:10px;"/>

<div style="text-align:left;"><div
class="violet"><br/>Can you hear this sound? <br/></div> (Click
speaker to replay)</div>

<br/>
 <br/><br/>

 <a href="#" id="yes"
onClick="manageSelection('yes');" class="btnUnselected"
style="margin-right:10px;margin-left:60px;">YES</a>
 <a href="#" id="no"
onClick="manageSelection('no');" class="btnUnselected"
style="margin-left:10px; margin-right:60px;">NO</a>

 <br/><br/><br/>
 <a href="#" id="next" onClick="nextQuestion();"
class="nextBtn">Next</a>


 </div>

 <div id="results" style="display:none">
 <br/><br/><br/><br/>

 <!--<div class="violet" style="font-size:14px">April 5th,
2014</div>--><canvas id="myChart" data-type="Line" width="250"
height="350" style="margin-left: -23px; margin-top: -
3px;"></canvas>
 <div id="submitResultsDiv" style="position: relative;
top:-15px;"></div>
 </div>

 <!-- Javascript -->
 <script>
 //$.mobile.loadingMessage = false;
var audio =
document.getElementById("testSound");
audio.addEventListener("touchstart", function()
{ audio.play(); }, false);
var flag;
var sounds = new Array();
var fileNames = ["250_-5.mp3", "250_5.mp3",
"250_15.mp3", "250_0.mp3", "250_10.mp3", "250_20.mp3",
"250_30.mp3", "250_40.mp3", "250_50.mp3", "250_60.mp3",
"250_70.mp3", "250_80.mp3",
"500_-5.mp3", "500_5.mp3", "500_15.mp3",
"500_0.mp3", "500_10.mp3", "500_20.mp3", "500_30.mp3",
"500_40.mp3", "500_50.mp3", "500_60.mp3", "500_70.mp3",
"500_80.mp3",
"1000_-5.mp3", "1000_5.mp3", "1000_15.mp3",
"1000_0.mp3", "1000_10.mp3", "1000_20.mp3", "1000_30.mp3",
"1000_40.mp3", "1000_50.mp3", "1000_60.mp3", "1000_70.mp3",
"1000_80.mp3",
"2000_-5.mp3", "2000_5.mp3", "2000_15.mp3",
"2000_0.mp3", "2000_10.mp3", "2000_20.mp3", "2000_30.mp3",
"2000_40.mp3", "2000_50.mp3", "2000_60.mp3", "2000_70.mp3",
"2000_80.mp3",
"4000_-5.mp3", "4000_5.mp3", "4000_15.mp3",
"4000_0.mp3", "4000_10.mp3", "4000_20.mp3", "4000_30.mp3",
"4000_40.mp3", "4000_50.mp3", "4000_60.mp3", "4000_70.mp3",
"4000_80.mp3",
"8000_-5.mp3", "8000_5.mp3", "8000_15.mp3",
"8000_0.mp3", "8000_10.mp3", "8000_20.mp3", "8000_30.mp3",
"8000_40.mp3", "8000_50.mp3", "8000_60.mp3", "8000_70.mp3",
"8000_80.mp3"];
function sound(fileName, frequency, db, result)
{
//result: -1 if uninitialized, 0 if
unheard, 1 if heard
this.fileName = fileName;
this.frequency = frequency;this.db = db;
this.result = result;
}
function testResult(frequency, db)
{
this.frequency = frequency;
this.db = db;
}


var qAsked;
var user;
var testResults = new Array();
var tempResult;
var speakerNum;
var interval = 0;
var progWidth = 0;
var database = window.openDatabase("MAAData1",
"1.0", "MobileAudiometryAppData1", 1000000);
 var storeResults;
 var storeDate;
 var flagForNewUser = 0;

function newTest()
{
 //alert("beginning of new test");
 //document.getElementById("testSound").stop();

document.getElementById("testSound").loop =
false;

document.getElementById('calibrate').style.display = 'none';

document.getElementById('selectProfile').style.display =
'inline';

document.getElementById('submitResultsDiv').innerHTML = '';

database.transaction(loadNames, queryError,
openSuccess);

qAsked = 0;
testResults = [];
flag = 0;
speakerNum = 2;
progWidth = 0;
 flagForNewUser = 0for(var i = 0; i<fileNames.length; i++)
{
fileName = fileNames[i];
var name = fileName.split(".");
var info = name[0].split("_");
var frequency = info[0];
var db = info[1];
var newSound = new sound(fileName,
parseInt(frequency), parseInt(db), -1);
sounds[fileName] = newSound;
}
}
function endTest()
{
var myAlert = "";
 document.getElementById("key").style.display =
"inline-block";
var temp = new Array();
for(var i = 0; i < testResults.length;
i++)
{
myAlert += "(" +
testResults[i].frequency + ", " + testResults[i].db + ")\n";
temp[temp.length] =
testResults[i].db;
}
//alert("End of Test. Results:\n\n" +
myAlert);
document.getElementById('takeTest').style.display = "none";
document.getElementById('results').style.display =
"inline";
 var d = new Date();
 var month=new Array();
 month[0]="January";
 month[1]="February";
 month[2]="March";
 month[3]="April";
month[4]="May";
 month[5]="June";
 month[6]="July";
 month[7]="August";
 month[8]="September";
 month[9]="October";
 month[10]="November";month[11]="December";

var date = "" + month[d.getMonth()] + " "
+ d.getDate() + ", " + d.getFullYear(); //REPLACE
var ctx =
document.getElementById("myChart").getContext("2d");
var data = {
labels :
["250","500","1000","2000","4000","8000"],

datasets : [
 {
fillColor :
"rgba(255,178,166,1)",
 strokeColor :
"rgba(255,178,166,1)",
 pointColor :
"rgba(255,178,166,1)",
pointStrokeColor : "#fff",
data : [80,80,80,80,80,80]
 },
 {
fillColor :
"rgba(255,213,166,1)",
strokeColor :
"rgba(255,213,166,1)",
pointColor :
"rgba(255,213,166,1)",
 pointStrokeColor : "#fff",
 data : [70,70,70,70,70,70]
},
{
fillColor :
"rgba(255,255,166,1)",
 strokeColor :
"rgba(255,255,166,1)",
 pointColor :
"rgba(255,255,166,1)",
pointStrokeColor : "#fff",
data : [40,40,40,40,40,40]
 },
 {
fillColor :
"rgba(166,255,190,1)",
strokeColor :
"rgba(166,255,190,1)",
pointColor :
"rgba(166,255,190,1)",pointStrokeColor : "#fff",
data : [20,20,20,20,20,20]
},
{
fillColor :
"rgba(255,255,255,0.6)",
strokeColor :
"rgba(136,136,136,1)",
pointColor :
"rgba(255,255,255,1)",
pointStrokeColor : "#fff",
data : temp
}
]
}
var options1 = {
scaleOverride : true,
 scaleSteps : 8,
 scaleStepWidth : 10,
 scaleStartValue : 0,
scaleOverlay : true,
scaleFontSize : 12,
scaleFontFamily : "'Open Sans'",
yAxisLeft : true,
 yAxisLabel : "Decibel Hearing Level",
 xAxisLabel : "Frequency (Hz)",
xAxisFontFamily : "'Open Sans'",
yAxisFontFamily : "'Open Sans'",
xAxisFontSize : 12,
yAxisFontSize : 12,
pointDot : false,
graphTitle : " " + date
}
var myNewChart = new Chart(ctx).Line(data,
options1);
//alert(temp);


 storeResults = temp.toString();
 storeDate = date;


document.getElementById('submitResultsDiv').innerHTML +=
'<br/><a href="#" id="saveResults" onClick="saveResults();"
class="nextBtn">Save Results</a>';}

 function saveResults()
 {
 if(flagForNewUser == 1){
 database.transaction(insertName, queryError,
insertSuccess);
 /////////////////////////changed this HERE
 }

//alert("inside save results");
 database.transaction(storeResultsFunction,
errorStoring, successStoring);
 //alert("Should have stored stuff");


document.getElementById('submitResultsDiv').innerHTML = '<br/><a
href="#" id="saveResults" void;" class="nextBtn">Save
Results</a>';

document.getElementById('saveResults').style.backgroundColor =
"#888888";

document.getElementById('saveResults').style.border = "1px solid
#888888";


 }


function plusProg()
 {
 for(var i=0; i < 100; i++)
 {
 document.getElementById("progress").value +=
1;
 }
 }
function nextQuestion()
{
if(document.getElementById("yes").className !=
"btnSelected" && document.getElementById("no").className !=
"btnSelected" && qAsked != 0)
{
return;
}//clearInterval(interval);
//interval = "";
//speakerNum=2;
//document.getElementById("speaker").src =
"speaker1.png";
//if(interval != 0)
//{
//clearInterval(interval);
//speakerNum=2;
//}
qDisplay = qAsked+1;
var file =
document.getElementById("testSound").src;
var path = file.split("/");
var fileName = path[path.length - 1];
if(qAsked != 0)
{
//store results
if(document.getElementById("yes").className ==
"btnSelected")
{
sounds[fileName].result = 1;
}
else
if(document.getElementById("no").className == "btnSelected")
{
sounds[fileName].result = 0;
}
document.getElementById("yes").className = "btnUnselected";
document.getElementById("no").className = "btnUnselected";
}
if(qAsked+1 == fileNames.length)
{
newTest();
//Question, if it's the last
frequency that they say yes to, are we not storing it bc of this
check?
endTest();
}
else{
if(qAsked == 0)
{
//first question
document.getElementById("testSound").src = "sounds/" +
"250_0.mp3";
playSound();
}
else
{
//display next question
var result =
sounds[fileName].result;
var db = sounds[fileName].db;
var frequency =
sounds[fileName].frequency;
var newSoundFile;
if(result == 1)
{
//alert("inside yes " +
flag);
if(db == 0)
{
//alert("played 0");
var newTestResult =
new testResult(frequency, db);
testResults[testResults.length] = newTestResult;
if(frequency == 8000)
{
//alert("ending
test");
endTest();
return;
}
else
{
//alert("playing new frequency bc yes on 0");
var
newFrequency = frequency * 2;
newSoundFile =
"sounds/" + newFrequency + "_0.mp3";
flag = 0;
progWidth +=
33;
plusProg();
}}
else if(db <= 20 && flag
== 0)
{
//alert("first time
saying yes");
tempResult = new
testResult(frequency, db);
//Question: algorithm
needs to be checked for how temp result is being handled
var newDb = db-5;
newSoundFile =
"sounds/" + frequency + "_" + newDb + ".mp3";
flag = 1;
//alert("changed flag
to " + flag);
}
else if(db <= 20 && flag
== 1)
{
//alert("second time
saying yes");
//save result of
current
var newTestResult =
new testResult(frequency, db);
testResults[testResults.length] = newTestResult;
if(frequency == 8000)
{
//alert("ending
test");
endTest();
return;
}
//alert("playing new
frequency");
var newFrequency =
frequency * 2;
newSoundFile =
"sounds/" + newFrequency + "_0.mp3";
flag = 0;
progWidth+=33;
plusProg();
}
else if(db > 20)
{
//alert("yes on db
above 20");var newTestResult =
new testResult(frequency, db);
testResults[testResults.length] = newTestResult;
if(frequency == 8000)
{
//alert("ending
test");
endTest();
return;
}
//alert("playing new
frequency");
var newFrequency =
frequency * 2;
newSoundFile =
"sounds/" + newFrequency + "_0.mp3";
flag = 0;
progWidth += 33;
plusProg();
}
}
else if(result == 0)
{
//alert("inside no");
if(flag == 1)
{
//alert("flag = 1
inside no");
//alert("saving
results " + tempResult.frequency + " " + tempResult.db);
testResults[testResults.length] = tempResult;
if(frequency == 8000)
{
//alert("ending
test");
endTest();
return;
}
//alert("playing new
frequency bc flag=1 in no");
var newFrequency =
frequency * 2;
newSoundFile = "sounds/" + newFrequency + "_0.mp3";
flag = 0;
progWidth += 33;
plusProg();
}
else
{
if(db == 80)
{
var
newTestResult = new testResult(frequency, db);
testResults[testResults.length] = newTestResult;
if(frequency ==
8000)
{
endTest();
return;
}
else
{
//alert("playing new frequency bc db=80");
var
newFrequency = frequency * 2;
newSoundFile = "sounds/" + newFrequency + "_0.mp3";
flag = 0;
progWidth
+= 33;
plusProg();
}
}
else
{
//alert("playing new tone with db +10");
var newDb = db
+ 10;
newSoundFile =
"sounds/" + frequency + "_" + newDb + ".mp3";
}
}
}
else {alert("error: the result
is still undefined");}
//alert(newSoundFile);document.getElementById("testSound").src = newSoundFile;
playSound();
}
qAsked++;
}
}
function playSound()
{
if(interval != 0)
{
clearInterval(interval);
speakerNum=2;
flag1 = 0;
}
document.getElementById("speaker").src =
"speaker1.png";
document.getElementById("testSound").play();
interval=setInterval(function(){animate()},400);
}
var flag1 = 0;
function animate()
{
if(flag1 == 7)
{
clearInterval(interval);
speakerNum=2;
interval = 0;
flag1 = 0;
return;
}
document.getElementById("speaker").src =
"speaker" + speakerNum + ".png";
speakerNum++;
flag1++;
if(speakerNum == 5)
{
speakerNum = 1;
}
}
function beginTest()
{
if(document.getElementById('existingUser').disabled ==false)
{
var inputBox =
document.getElementById("existingUser");
user =
inputBox.options[inputBox.selectedIndex].text;

document.getElementById('selectProfile').style.display = "none";

document.getElementById('takeTest').style.display = "inline";
 nextQuestion();
}
else
{
user =
document.getElementById("newUser").value;
 if(user=="")
{
 alert("Error: User name cannot be
blank");
 return;
 }
flagForNewUser = 1;
user = user.toLowerCase();
 // database.transaction(insertName,
queryError, insertSuccess);

document.getElementById('selectProfile').style.display = "none";

document.getElementById('takeTest').style.display = "inline";
 nextQuestion();
}
}
function disableEnable(dis, en)
{
document.getElementById(dis).disabled=true;
document.getElementById(en).disabled=false;
}
function manageSelection(btnid)
{
var other;
if(btnid=="yes")
{ other = "no";}
else
{other = "yes";
}
document.getElementById(btnid).className =
"btnSelected";
document.getElementById(other).className =
"btnUnselected";
}


 //beginning of database stuff


 function storeResultsFunction(tx)
 {
 //alert("inside storeResultsFunction(tx)");
 tx.executeSql("SELECT dates, data FROM maa WHERE
name='" + user + "'", [], findStoredSuccess,findStoredError);
 //alert("end of storeResults(tx)");
 }

 function findStoredSuccess(tx, results)
 {
 //alert("inside findStoredSuccess");
 var dates =
(storeDate.concat(".")).concat(results.rows.item(0).dates);
 var data =
(storeResults.concat(".")).concat(results.rows.item(0).data);
 tx.executeSql("UPDATE maa SET dates='" + dates + "',
data='" + data + "' WHERE name='" + user + "'");
 //alert("end of findStoredSuccess");
 }

 function findStoredError(err)
 {
 //alert("Error: Could not access stored results " +
err);
 }

 function errorStoring(err)
 {
 alert("Error: Cannot store results" + err);
 }

 function successStoring()
 {
 //alert("Successfully stored Results");
 }function openSuccess()
 {
 //alert("success!");

 }

 function insertSuccess()
 {
 //alert("insert success!");


 }

 function insertName(tx)
 {
 tx.executeSql('INSERT INTO maa (name) VALUES("' +
user + '")');
 }


 function loadNames(tx)
 {
 //alert("0");
 tx.executeSql('CREATE TABLE IF NOT EXISTS maa (name
varchar(255) NOT NULL PRIMARY KEY, dates varchar(8000), data
varchar(8000))');
 tx.executeSql('SELECT name FROM maa', [],
querySuccess, queryError);
 }


 function querySuccess(tx, results)
 {

 var divContent =
document.getElementById("existingUser");
 var len = results.rows.length;
 for(var i = 0; i<len; i++)
 {
 var option = document.createElement("option");
 option.text = results.rows.item(i).name;
 option.value = results.rows.item(i).name;
divContent.add(option);
 }

 }function queryError(err)
 {
 alert("Error: Name Already Exists");
 }</script>
 <script src="assets/js/jquery-1.8.2.min.js"></script>
 <script
src="assets/bootstrap/js/bootstrap.min.js"></script>
 <script src="assets/js/jquery.flexslider.js"></script>
 <script src="assets/js/jquery.tweet.js"></script>
 <script src="assets/js/jflickrfeed.js"></script>
 <script
src="http://maps.google.com/maps/api/js?sensor=true"></script>
 <script src="assets/js/jquery.ui.map.min.js"></script>
 <script src="assets/js/jquery.quicksand.js"></script>
 <script
src="assets/prettyPhoto/js/jquery.prettyPhoto.js"></script>
 <script src="assets/js/scripts.js"></script>
 </body>
</html>
